FROM cartesi/image-tournament-blockchain-base:latest as blockchain-base

FROM ubuntu:18.04

MAINTAINER Stephen Chen <stephen@cartesi.io>

ENV BASE /opt/cartesi

# Install basic development tools
# ----------------------------------------------------
RUN \
    apt-get update && \
    apt-get install --no-install-recommends -y \
        openssh-client \
        unzip build-essential autoconf automake libtool git \
        make curl g++ gcc libssl-dev pkg-config ca-certificates cmake && \
    mkdir -p $BASE

RUN mkdir -m 700 /root/.ssh

# This is necessary to prevent the "git clone" operation from failing
# with an "unknown host key" error.
RUN touch -m 600 /root/.ssh/known_hosts; \
  ssh-keyscan github.com > /root/.ssh/known_hosts

# Install protobuf
# ----------------------------------------------------
WORKDIR $BASE
RUN \
    git clone --recurse-submodules --depth 1 https://github.com/protocolbuffers/protobuf.git

WORKDIR $BASE/protobuf
RUN \
    NPROC=$(nproc) && \
    ./autogen.sh && \
    ./configure && \
    make -j$NPROC && \
    make -j$NPROC check && \
    make -j$NPROC install && \
    ldconfig

WORKDIR $BASE

# Installing rust stable
# ----------------------------------------------------
RUN \
    curl -f -L https://static.rust-lang.org/rustup.sh -O && \
    sh rustup.sh -y

# Loading cargo bin in path
ENV PATH="/root/.cargo/bin:$PATH"

COPY ./lib/ $BASE/lib
RUN \
    rm -rf $BASE/protobuf

RUN mkdir -p $BASE/compute/src
COPY ./dispatcher/ $BASE/dispatcher

WORKDIR $BASE/compute
# RUN cargo install cargo-build-deps

# Compile dependencies
COPY ./compute/Cargo.toml ./
COPY ./compute/Cargo.lock ./
RUN echo "fn main() { }" > ./src/main.rs
RUN cargo build

# Compile tournament test
COPY ./compute/src ./src
RUN cargo build

COPY --from=blockchain-base $BASE/*.yaml $BASE/
COPY --from=blockchain-base $BASE/blockchain_files $BASE/blockchain_files
RUN mkdir -p $BASE/wallet

USER root

SHELL ["/bin/bash", "-c"]

CMD \
    export RUST_LOG=dispatcher=trace,transaction=trace,configuration=trace,utils=trace,state=trace,compute=trace,hasher=trace,dappmock=trace,match=trace,matchmanager=trace,revealmock=trace && \
    source /opt/cartesi/wallet/cartesi_concern_key && \
    mkdir -p /opt/cartesi/working_path && \
    cat /opt/cartesi/wallet/dispatcher_config.yaml && \
    cargo run -- --config_path /opt/cartesi/wallet/dispatcher_config.yaml --working_path /opt/cartesi/working_path
